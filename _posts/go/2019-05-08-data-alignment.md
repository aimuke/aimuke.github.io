---
title: "åœ¨Goä¸­å†…å­˜å¯¹é½"
tags: [go, padding, 'Data alignment']
---

åœ¨golang mapçš„æºç ä¸­å‘ç°äº†ä¸€æ®µå…³äºå¯¹é½çš„æè¿°ï¼Œæ²¡æœ‰ç†è§£åˆ°å…¶ä¸­çš„å«ä¹‰ï¼ŒæŸ¥è¯¢äº†ä¸€ä¸‹ååœ¨githubä¸Šæ‰¾åˆ°äº†ä¸€ç¯‡[ç›¸å…³çš„ä»‹ç»](https://github.com/EDDYCJY/blog/blob/master/golang/2018-12-26-%E5%9C%A8Go%E4%B8%AD%E6%81%B0%E5%88%B0%E5%A5%BD%E5%A4%84%E7%9A%84%E5%86%85%E5%AD%98%E5%AF%B9%E9%BD%90.md)ï¼Œè¿™é‡Œå¼•ç”¨ä¸€ä¸‹ã€‚

```go
// A bucket for a Go map.
type bmap struct {
	// tophash generally contains the top byte of the hash value
	// for each key in this bucket. If tophash[0] < minTopHash,
	// tophash[0] is a bucket evacuation state instead.
	tophash [bucketCnt]uint8
	// Followed by bucketCnt keys and then bucketCnt values.
	// NOTE: packing all the keys together and then all the values together makes the
	// code a bit more complicated than alternating key/value/key/value/... but it allows
	// us to eliminate padding which would be needed for, e.g., map[int64]int8.
	// Followed by an overflow pointer.
}
```

å¦‚ä¸Šï¼Œæ³¨é‡Šä¸­è¯´å­˜å‚¨çš„æ—¶å€™æ˜¯å°†`key`å…ˆæ”¾åˆ°ä¸€èµ·ï¼Œåœ¨å°†`value`æ”¾åˆ°ä¸€èµ·ï¼Œè¿™æ ·èƒ½å¤Ÿæ¶ˆé™¤å¯¹é½å¸¦æ¥çš„é—®é¢˜, å…¶ä¸­çš„åŸå› å¦‚ä¸‹:

# é—®é¢˜

```go
type Part1 struct {
	a bool
	b int32
	c int8
	d int64
	e byte
}
```

åœ¨å¼€å§‹ä¹‹å‰ï¼Œå¸Œæœ›ä½ è®¡ç®—ä¸€ä¸‹ `Part1` å…±å ç”¨çš„å¤§å°æ˜¯å¤šå°‘å‘¢ï¼Ÿ

```go
func main() {
	fmt.Printf("bool size: %d\n", unsafe.Sizeof(bool(true)))
	fmt.Printf("int32 size: %d\n", unsafe.Sizeof(int32(0)))
	fmt.Printf("int8 size: %d\n", unsafe.Sizeof(int8(0)))
	fmt.Printf("int64 size: %d\n", unsafe.Sizeof(int64(0)))
	fmt.Printf("byte size: %d\n", unsafe.Sizeof(byte(0)))
	fmt.Printf("string size: %d\n", unsafe.Sizeof("EDDYCJY"))
}
```

è¾“å‡ºç»“æœï¼š

```
bool size: 1
int32 size: 4
int8 size: 1
int64 size: 8
byte size: 1
string size: 16
```

è¿™ä¹ˆä¸€ç®—ï¼Œ`Part1` è¿™ä¸€ä¸ªç»“æ„ä½“çš„å ç”¨å†…å­˜å¤§å°ä¸º `1+4+1+8+1 = 15` ä¸ªå­—èŠ‚ã€‚ç›¸ä¿¡æœ‰çš„å°ä¼™ä¼´æ˜¯è¿™ä¹ˆç®—çš„ï¼Œçœ‹ä¸Šå»ä¹Ÿæ²¡ä»€ä¹ˆæ¯›ç—…

çœŸå®æƒ…å†µæ˜¯æ€ä¹ˆæ ·çš„å‘¢ï¼Ÿæˆ‘ä»¬å®é™…è°ƒç”¨çœ‹çœ‹ï¼Œå¦‚ä¸‹ï¼š

```go
type Part1 struct {
	a bool
	b int32
	c int8
	d int64
	e byte
}

func main() {
	part1 := Part1{}
	
	fmt.Printf("part1 size: %d, align: %d\n", unsafe.Sizeof(part1), unsafe.Alignof(part1))
}
```

è¾“å‡ºç»“æœï¼š

```
part1 size: 32, align: 8
```

æœ€ç»ˆè¾“å‡ºä¸ºå ç”¨ 32 ä¸ªå­—èŠ‚ã€‚è¿™ä¸å‰é¢æ‰€é¢„æœŸçš„ç»“æœå®Œå…¨ä¸ä¸€æ ·ã€‚è¿™å……åˆ†åœ°è¯´æ˜äº†å…ˆå‰çš„è®¡ç®—æ–¹å¼æ˜¯é”™è¯¯çš„ã€‚ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ

åœ¨è¿™é‡Œè¦æåˆ° â€œå†…å­˜å¯¹é½â€ è¿™ä¸€æ¦‚å¿µï¼Œæ‰èƒ½å¤Ÿç”¨æ­£ç¡®çš„å§¿åŠ¿å»è®¡ç®—ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬è¯¦ç»†çš„è®²è®²å®ƒæ˜¯ä»€ä¹ˆ

# å†…å­˜å¯¹é½

æœ‰çš„å°ä¼™ä¼´å¯èƒ½ä¼šè®¤ä¸ºå†…å­˜è¯»å–ï¼Œå°±æ˜¯ä¸€ä¸ªç®€å•çš„å­—èŠ‚æ•°ç»„æ‘†æ”¾

![image](https://camo.githubusercontent.com/75eec73b37a770f4cd45aa2d2e61e283e5405ee9/68747470733a2f2f692e696d6775722e636f6d2f535a48514a4b372e706e67)

ä¸Šå›¾è¡¨ç¤ºä¸€ä¸ªå‘ä¸€ä¸ªèåœçš„å†…å­˜è¯»å–æ–¹å¼ã€‚ä½†å®é™…ä¸Š CPU å¹¶ä¸ä¼šä»¥ä¸€ä¸ªä¸€ä¸ªå­—èŠ‚å»è¯»å–å’Œå†™å…¥å†…å­˜ã€‚ç›¸å CPU è¯»å–å†…å­˜æ˜¯**ä¸€å—ä¸€å—è¯»å–**çš„ï¼Œå—çš„å¤§å°å¯ä»¥ä¸º 2ã€4ã€6ã€8ã€16 å­—èŠ‚ç­‰å¤§å°ã€‚å—å¤§å°æˆ‘ä»¬ç§°å…¶ä¸º**å†…å­˜è®¿é—®ç²’åº¦**ã€‚å¦‚ä¸‹å›¾ï¼š

![image](https://camo.githubusercontent.com/e42eac1dab3ac90560cd52c6c274c5c9ddcf5e3c/68747470733a2f2f692e696d6775722e636f6d2f6d43465a5765382e706e67)

åœ¨æ ·ä¾‹ä¸­ï¼Œå‡è®¾è®¿é—®ç²’åº¦ä¸º 4ã€‚ CPU æ˜¯ä»¥æ¯ 4 ä¸ªå­—èŠ‚å¤§å°çš„è®¿é—®ç²’åº¦å»è¯»å–å’Œå†™å…¥å†…å­˜çš„ã€‚è¿™æ‰æ˜¯æ­£ç¡®çš„å§¿åŠ¿

## ä¸ºä»€ä¹ˆè¦å…³å¿ƒå¯¹é½

- ä½ æ­£åœ¨ç¼–å†™çš„ä»£ç åœ¨æ€§èƒ½ï¼ˆCPUã€Memoryï¼‰æ–¹é¢æœ‰ä¸€å®šçš„è¦æ±‚
- ä½ æ­£åœ¨å¤„ç†å‘é‡æ–¹é¢çš„æŒ‡ä»¤
- æŸäº›ç¡¬ä»¶å¹³å°ï¼ˆARMï¼‰ä½“ç³»ä¸æ”¯æŒæœªå¯¹é½çš„å†…å­˜è®¿é—®

å¦å¤–ä½œä¸ºä¸€ä¸ªå·¥ç¨‹å¸ˆï¼Œä½ ä¹Ÿå¾ˆæœ‰å¿…è¦å­¦ä¹ è¿™å—çŸ¥è¯†ç‚¹å“¦ :)

## ä¸ºä»€ä¹ˆè¦åšå¯¹é½

- å¹³å°ï¼ˆç§»æ¤æ€§ï¼‰åŸå› ï¼šä¸æ˜¯æ‰€æœ‰çš„ç¡¬ä»¶å¹³å°éƒ½èƒ½å¤Ÿè®¿é—®ä»»æ„åœ°å€ä¸Šçš„ä»»æ„æ•°æ®ã€‚ä¾‹å¦‚ï¼šç‰¹å®šçš„ç¡¬ä»¶å¹³å°åªå…è®¸åœ¨ç‰¹å®šåœ°å€è·å–ç‰¹å®šç±»å‹çš„æ•°æ®ï¼Œå¦åˆ™ä¼šå¯¼è‡´å¼‚å¸¸æƒ…å†µ
- æ€§èƒ½åŸå› ï¼šè‹¥è®¿é—®æœªå¯¹é½çš„å†…å­˜ï¼Œå°†ä¼šå¯¼è‡´ CPU è¿›è¡Œä¸¤æ¬¡å†…å­˜è®¿é—®ï¼Œå¹¶ä¸”è¦èŠ±è´¹é¢å¤–çš„æ—¶é’Ÿå‘¨æœŸæ¥å¤„ç†å¯¹é½åŠè¿ç®—ã€‚è€Œæœ¬èº«å°±å¯¹é½çš„å†…å­˜ä»…éœ€è¦ä¸€æ¬¡è®¿é—®å°±å¯ä»¥å®Œæˆè¯»å–åŠ¨ä½œ

![image](https://camo.githubusercontent.com/0c7bed49e0cf585583362cb6fe16b0c5721e07d5/68747470733a2f2f692e696d6775722e636f6d2f6731527855547a2e706e67)

åœ¨ä¸Šå›¾ä¸­ï¼Œå‡è®¾ä» Index 1 å¼€å§‹è¯»å–ï¼Œå°†ä¼šå‡ºç°å¾ˆå´©æºƒçš„é—®é¢˜ã€‚å› ä¸ºå®ƒçš„å†…å­˜è®¿é—®è¾¹ç•Œæ˜¯ä¸å¯¹é½çš„ã€‚å› æ­¤ CPU ä¼šåšä¸€äº›é¢å¤–çš„å¤„ç†å·¥ä½œã€‚å¦‚ä¸‹ï¼š

1. CPU **é¦–æ¬¡**è¯»å–æœªå¯¹é½åœ°å€çš„ç¬¬ä¸€ä¸ªå†…å­˜å—ï¼Œè¯»å– 0-3 å­—èŠ‚ã€‚å¹¶ç§»é™¤ä¸éœ€è¦çš„å­—èŠ‚ 0
2. CPU **å†æ¬¡**è¯»å–æœªå¯¹é½åœ°å€çš„ç¬¬äºŒä¸ªå†…å­˜å—ï¼Œè¯»å– 4-7 å­—èŠ‚ã€‚å¹¶ç§»é™¤ä¸éœ€è¦çš„å­—èŠ‚ 5ã€6ã€7 å­—èŠ‚
3. åˆå¹¶ 1-4 å­—èŠ‚çš„æ•°æ®
4. åˆå¹¶åæ”¾å…¥å¯„å­˜å™¨

ä»ä¸Šè¿°æµç¨‹å¯å¾—å‡ºï¼Œä¸åš â€œå†…å­˜å¯¹é½â€ æ˜¯ä¸€ä»¶æœ‰ç‚¹ "éº»çƒ¦" çš„äº‹ã€‚å› ä¸ºå®ƒä¼šå¢åŠ è®¸å¤šè€—è´¹æ—¶é—´çš„åŠ¨ä½œ

è€Œå‡è®¾åšäº†å†…å­˜å¯¹é½ï¼Œä» Index 0 å¼€å§‹è¯»å– 4 ä¸ªå­—èŠ‚ï¼Œåªéœ€è¦è¯»å–ä¸€æ¬¡ï¼Œä¹Ÿä¸éœ€è¦é¢å¤–çš„è¿ç®—ã€‚è¿™æ˜¾ç„¶é«˜æ•ˆå¾ˆå¤šï¼Œæ˜¯æ ‡å‡†çš„**ç©ºé—´æ¢æ—¶é—´**åšæ³•

## é»˜è®¤ç³»æ•°

åœ¨ä¸åŒå¹³å°ä¸Šçš„ç¼–è¯‘å™¨éƒ½æœ‰è‡ªå·±é»˜è®¤çš„ â€œå¯¹é½ç³»æ•°â€ï¼Œå¯é€šè¿‡é¢„ç¼–è¯‘å‘½ä»¤ `#pragma pack(n)` è¿›è¡Œå˜æ›´ï¼Œn å°±æ˜¯ä»£æŒ‡ â€œå¯¹é½ç³»æ•°â€ã€‚ä¸€èˆ¬æ¥è®²ï¼Œæˆ‘ä»¬å¸¸ç”¨çš„å¹³å°çš„ç³»æ•°å¦‚ä¸‹ï¼š

- 32 ä½ï¼š4
- 64 ä½ï¼š8

å¦å¤–è¦æ³¨æ„ï¼Œä¸åŒç¡¬ä»¶å¹³å°å ç”¨çš„å¤§å°å’Œå¯¹é½å€¼éƒ½å¯èƒ½æ˜¯ä¸ä¸€æ ·çš„ã€‚å› æ­¤æœ¬æ–‡çš„å€¼ä¸æ˜¯å”¯ä¸€çš„ï¼Œè°ƒè¯•çš„æ—¶å€™éœ€æŒ‰æœ¬æœºçš„å®é™…æƒ…å†µè€ƒè™‘

## æˆå‘˜å¯¹é½

```
func main() {
	fmt.Printf("bool align: %d\n", unsafe.Alignof(bool(true)))
	fmt.Printf("int32 align: %d\n", unsafe.Alignof(int32(0)))
	fmt.Printf("int8 align: %d\n", unsafe.Alignof(int8(0)))
	fmt.Printf("int64 align: %d\n", unsafe.Alignof(int64(0)))
	fmt.Printf("byte align: %d\n", unsafe.Alignof(byte(0)))
	fmt.Printf("string align: %d\n", unsafe.Alignof("EDDYCJY"))
	fmt.Printf("map align: %d\n", unsafe.Alignof(map[string]string{}))
}
```

è¾“å‡ºç»“æœï¼š

```
bool align: 1
int32 align: 4
int8 align: 1
int64 align: 8
byte align: 1
string align: 8
map align: 8
```

åœ¨ Go ä¸­å¯ä»¥è°ƒç”¨ `unsafe.Alignof` æ¥è¿”å›ç›¸åº”ç±»å‹çš„å¯¹é½ç³»æ•°ã€‚é€šè¿‡è§‚å¯Ÿè¾“å‡ºç»“æœï¼Œå¯å¾—çŸ¥åŸºæœ¬éƒ½æ˜¯ `2^n`ï¼Œæœ€å¤§ä¹Ÿä¸ä¼šè¶…è¿‡ 8ã€‚è¿™æ˜¯å› ä¸ºæˆ‘æ‰‹æï¼ˆ64 ä½ï¼‰ç¼–è¯‘å™¨é»˜è®¤å¯¹é½ç³»æ•°æ˜¯ 8ï¼Œå› æ­¤æœ€å¤§å€¼ä¸ä¼šè¶…è¿‡è¿™ä¸ªæ•°

## æ•´ä½“å¯¹é½

åœ¨ä¸Šå°èŠ‚ä¸­ï¼Œæåˆ°äº†ç»“æ„ä½“ä¸­çš„æˆå‘˜å˜é‡è¦åšå­—èŠ‚å¯¹é½ã€‚é‚£ä¹ˆæƒ³å½“ç„¶èº«ä¸ºæœ€ç»ˆç»“æœçš„ç»“æ„ä½“ï¼Œä¹Ÿæ˜¯éœ€è¦åšå­—èŠ‚å¯¹é½çš„

## å¯¹é½è§„åˆ™

- ç»“æ„ä½“çš„æˆå‘˜å˜é‡ï¼Œç¬¬ä¸€ä¸ªæˆå‘˜å˜é‡çš„åç§»é‡ä¸º 0ã€‚å¾€åçš„æ¯ä¸ªæˆå‘˜å˜é‡çš„å¯¹é½å€¼å¿…é¡»ä¸º**ç¼–è¯‘å™¨é»˜è®¤å¯¹é½é•¿åº¦**ï¼ˆ`#pragma pack(n)`ï¼‰æˆ–**å½“å‰æˆå‘˜å˜é‡ç±»å‹çš„é•¿åº¦**ï¼ˆ`unsafe.Sizeof`ï¼‰ï¼Œå–**æœ€å°å€¼ä½œä¸ºå½“å‰ç±»å‹çš„å¯¹é½å€¼**ã€‚å…¶åç§»é‡å¿…é¡»ä¸ºå¯¹é½å€¼çš„æ•´æ•°å€
- ç»“æ„ä½“æœ¬èº«ï¼Œå¯¹é½å€¼å¿…é¡»ä¸º**ç¼–è¯‘å™¨é»˜è®¤å¯¹é½é•¿åº¦**ï¼ˆ`#pragma pack(n)`ï¼‰æˆ–**ç»“æ„ä½“çš„æ‰€æœ‰æˆå‘˜å˜é‡ç±»å‹ä¸­çš„æœ€å¤§é•¿åº¦**ï¼Œå–**æœ€å¤§æ•°çš„æœ€å°æ•´æ•°å€**ä½œä¸ºå¯¹é½å€¼
- ç»“åˆä»¥ä¸Šä¸¤ç‚¹ï¼Œå¯å¾—çŸ¥è‹¥**ç¼–è¯‘å™¨é»˜è®¤å¯¹é½é•¿åº¦**ï¼ˆ`#pragma pack(n)`ï¼‰è¶…è¿‡ç»“æ„ä½“å†…æˆå‘˜å˜é‡çš„ç±»å‹æœ€å¤§é•¿åº¦æ—¶ï¼Œé»˜è®¤å¯¹é½é•¿åº¦æ˜¯æ²¡æœ‰ä»»ä½•æ„ä¹‰çš„

# åˆ†ææµç¨‹

æ¥ä¸‹æ¥æˆ‘ä»¬ä¸€èµ·åˆ†æä¸€ä¸‹ï¼Œâ€œå®ƒâ€ åˆ°åº•ç»å†äº†äº›ä»€ä¹ˆï¼Œå½±å“äº† â€œé¢„æœŸâ€ ç»“æœ

æˆå‘˜å˜é‡ | ç±»å‹ | åç§»é‡ | è‡ªèº«å ç”¨
---|---|---|---
a | bool | 0 | 1
å­—èŠ‚å¯¹é½ | æ—  | 1 | 3
b | int32 | 4 | 4 
c | int8 | 8 | 1
å­—èŠ‚å¯¹é½ | æ—  | 9 | 7
d | int64 | 16 | 8
e | byte | 24 | 1
å­—èŠ‚å¯¹é½ | æ—  | 25 | 7
æ€»å ç”¨å¤§å° | - | - | 32

## æˆå‘˜å¯¹é½

- ç¬¬ä¸€ä¸ªæˆå‘˜ a
   - ç±»å‹ä¸º bool
   - å¤§å°/å¯¹é½å€¼ä¸º 1 å­—èŠ‚
   - åˆå§‹åœ°å€ï¼Œåç§»é‡ä¸º 0ã€‚å ç”¨äº†ç¬¬ 1 ä½
- ç¬¬äºŒä¸ªæˆå‘˜ b
   - ç±»å‹ä¸º int32
   - å¤§å°/å¯¹é½å€¼ä¸º 4 å­—èŠ‚
   - æ ¹æ®è§„åˆ™ 1ï¼Œå…¶åç§»é‡å¿…é¡»ä¸º 4 çš„æ•´æ•°å€ã€‚ç¡®å®šåç§»é‡ä¸º 4ï¼Œå› æ­¤ 2-4 ä½ä¸º Paddingã€‚è€Œå½“å‰æ•°å€¼ä»ç¬¬ 5 ä½å¼€å§‹å¡«å……ï¼Œåˆ°ç¬¬ 8 ä½ã€‚å¦‚ä¸‹ï¼šaxxx\|bbbb
- ç¬¬ä¸‰ä¸ªæˆå‘˜ c
   - ç±»å‹ä¸º int8
   - å¤§å°/å¯¹é½å€¼ä¸º 1 å­—èŠ‚
   - æ ¹æ®è§„åˆ™1ï¼Œå…¶åç§»é‡å¿…é¡»ä¸º 1 çš„æ•´æ•°å€ã€‚å½“å‰åç§»é‡ä¸º 8ã€‚ä¸éœ€è¦é¢å¤–å¯¹é½ï¼Œå¡«å…… 1 ä¸ªå­—èŠ‚åˆ°ç¬¬ 9 ä½ã€‚å¦‚ä¸‹ï¼šaxxx\|bbbb\|c...
- ç¬¬å››ä¸ªæˆå‘˜ d
    - ç±»å‹ä¸º int64
    - å¤§å°/å¯¹é½å€¼ä¸º 8 å­—èŠ‚
    - æ ¹æ®è§„åˆ™ 1ï¼Œå…¶åç§»é‡å¿…é¡»ä¸º 8 çš„æ•´æ•°å€ã€‚ç¡®å®šåç§»é‡ä¸º 16ï¼Œå› æ­¤
9-16 ä½ä¸º Paddingã€‚è€Œå½“å‰æ•°å€¼ä»ç¬¬ 17 ä½å¼€å§‹å†™å…¥ï¼Œåˆ°ç¬¬ 24 ä½ã€‚å¦‚ä¸‹ï¼šaxxx\|bbbb\|cxxx\|xxxx\|dddd\|dddd
- ç¬¬äº”ä¸ªæˆå‘˜ e
   - ç±»å‹ä¸º byte
   - å¤§å°/å¯¹é½å€¼ä¸º 1 å­—èŠ‚
   - æ ¹æ®è§„åˆ™ 1ï¼Œå…¶åç§»é‡å¿…é¡»ä¸º 1 çš„æ•´æ•°å€ã€‚å½“å‰åç§»é‡ä¸º 24ã€‚ä¸éœ€è¦é¢å¤–å¯¹é½ï¼Œå¡«å…… 1 ä¸ªå­—èŠ‚åˆ°ç¬¬ 25 ä½ã€‚å¦‚ä¸‹ï¼šaxxx\|bbbb\|cxxx\|xxxx\|dddd\|dddd\|e...

## æ•´ä½“å¯¹é½

åœ¨æ¯ä¸ªæˆå‘˜å˜é‡è¿›è¡Œå¯¹é½åï¼Œæ ¹æ®è§„åˆ™ 2ï¼Œæ•´ä¸ªç»“æ„ä½“æœ¬èº«ä¹Ÿè¦è¿›è¡Œå­—èŠ‚å¯¹é½ï¼Œå› ä¸ºå¯å‘ç°å®ƒå¯èƒ½å¹¶ä¸æ˜¯ `2^n`ï¼Œä¸æ˜¯å¶æ•°å€ã€‚æ˜¾ç„¶ä¸ç¬¦åˆå¯¹é½çš„è§„åˆ™

æ ¹æ®è§„åˆ™ 2ï¼Œå¯å¾—å‡ºå¯¹é½å€¼ä¸º 8ã€‚ç°åœ¨çš„åç§»é‡ä¸º 25ï¼Œä¸æ˜¯ 8 çš„æ•´å€æ•°ã€‚å› æ­¤ç¡®å®šåç§»é‡ä¸º 32ã€‚å¯¹ç»“æ„ä½“è¿›è¡Œå¯¹é½

## ç»“æœ

Part1 å†…å­˜å¸ƒå±€ï¼šaxxx\|bbbb\|cxxx\|xxxx\|dddd\|dddd\|exxx\|xxxx

## å°ç»“

é€šè¿‡æœ¬èŠ‚çš„åˆ†æï¼Œå¯å¾—çŸ¥å…ˆå‰çš„ â€œæ¨ç®—â€ ä¸ºä»€ä¹ˆé”™è¯¯ï¼Ÿ

æ˜¯å› ä¸ºå®é™…å†…å­˜ç®¡ç†å¹¶é â€œä¸€ä¸ªèåœä¸€ä¸ªå‘â€ çš„æ€æƒ³ã€‚è€Œæ˜¯ä¸€å—ä¸€å—ã€‚é€šè¿‡ç©ºé—´æ¢æ—¶é—´ï¼ˆæ•ˆç‡ï¼‰çš„æ€æƒ³æ¥å®Œæˆè¿™å—è¯»å–ã€å†™å…¥ã€‚å¦å¤–ä¹Ÿéœ€è¦å…¼é¡¾ä¸åŒå¹³å°çš„å†…å­˜æ“ä½œæƒ…å†µ

# å·§å¦™çš„ç»“æ„ä½“

åœ¨ä¸Šä¸€å°èŠ‚ï¼Œå¯å¾—çŸ¥æ ¹æ®æˆå‘˜å˜é‡çš„ç±»å‹ä¸åŒï¼Œå…¶ç»“æ„ä½“çš„å†…å­˜ä¼šäº§ç”Ÿå¯¹é½ç­‰åŠ¨ä½œã€‚é‚£å‡è®¾å­—æ®µé¡ºåºä¸åŒï¼Œä¼šä¸ä¼šæœ‰ä»€ä¹ˆå˜åŒ–å‘¢ï¼Ÿæˆ‘ä»¬ä¸€èµ·æ¥è¯•è¯•å§ :-)

```
type Part1 struct {
	a bool
	b int32
	c int8
	d int64
	e byte
}

type Part2 struct {
	e byte
	c int8
	a bool
	b int32
	d int64
}

func main() {
	part1 := Part1{}
	part2 := Part2{}

	fmt.Printf("part1 size: %d, align: %d\n", unsafe.Sizeof(part1), unsafe.Alignof(part1))
	fmt.Printf("part2 size: %d, align: %d\n", unsafe.Sizeof(part2), unsafe.Alignof(part2))
}
```

è¾“å‡ºç»“æœï¼š

```
part1 size: 32, align: 8
part2 size: 16, align: 8
```

é€šè¿‡ç»“æœå¯ä»¥æƒŠå–œçš„å‘ç°ï¼Œåªæ˜¯ â€œç®€å•â€ å¯¹æˆå‘˜å˜é‡çš„å­—æ®µé¡ºåºè¿›è¡Œæ”¹å˜ï¼Œå°±æ”¹å˜äº†ç»“æ„ä½“å ç”¨å¤§å°

æ¥ä¸‹æ¥æˆ‘ä»¬ä¸€èµ·å‰–æä¸€ä¸‹ `Part2`ï¼Œçœ‹çœ‹å®ƒçš„å†…éƒ¨åˆ°åº•å’Œä¸Šä¸€ä½ä¹‹é—´æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Œæ‰å¯¼è‡´äº†è¿™æ ·çš„ç»“æœï¼Ÿ

## åˆ†ææµç¨‹

æˆå‘˜å˜é‡ | ç±»å‹ | åç§»é‡ | è‡ªèº«å ç”¨
---|---|---|---
e | byte  | 0 | 1
c | int8  | 1 | 1
a | bool  | 2 | 1
å­—èŠ‚å¯¹é½ | æ—  | 3 | 1
b | int32 | 4 | 4
d | int64 | 8 | 8
æ€»å ç”¨å¤§å° | - | - | 16

### æˆå‘˜å¯¹é½

- ç¬¬ä¸€ä¸ªæˆå‘˜ e
   - ç±»å‹ä¸º byte
   - å¤§å°/å¯¹é½å€¼ä¸º 1 å­—èŠ‚
   - åˆå§‹åœ°å€ï¼Œåç§»é‡ä¸º 0ã€‚å ç”¨äº†ç¬¬ 1 ä½
- ç¬¬äºŒä¸ªæˆå‘˜ c
   - ç±»å‹ä¸º int8
   - å¤§å°/å¯¹é½å€¼ä¸º 1 å­—èŠ‚
   - æ ¹æ®è§„åˆ™1ï¼Œå…¶åç§»é‡å¿…é¡»ä¸º 1 çš„æ•´æ•°å€ã€‚å½“å‰åç§»é‡ä¸º 2ã€‚ä¸éœ€è¦é¢å¤–å¯¹é½
- ç¬¬ä¸‰ä¸ªæˆå‘˜ a
   - ç±»å‹ä¸º bool
   - å¤§å°/å¯¹é½å€¼ä¸º 1 å­—èŠ‚
   - æ ¹æ®è§„åˆ™1ï¼Œå…¶åç§»é‡å¿…é¡»ä¸º 1 çš„æ•´æ•°å€ã€‚å½“å‰åç§»é‡ä¸º 3ã€‚ä¸éœ€è¦é¢å¤–å¯¹é½
- ç¬¬å››ä¸ªæˆå‘˜ b
   - ç±»å‹ä¸º int32
   - å¤§å°/å¯¹é½å€¼ä¸º 4 å­—èŠ‚
   - æ ¹æ®è§„åˆ™1ï¼Œå…¶åç§»é‡å¿…é¡»ä¸º 4 çš„æ•´æ•°å€ã€‚ç¡®å®šåç§»é‡ä¸º 4ï¼Œå› æ­¤ç¬¬ 3 ä½ä¸º Paddingã€‚è€Œå½“å‰æ•°å€¼ä»ç¬¬ 4 ä½å¼€å§‹å¡«å……ï¼Œåˆ°ç¬¬ 8 ä½ã€‚å¦‚ä¸‹ï¼šecax\|bbbb
- ç¬¬äº”ä¸ªæˆå‘˜ d
   - ç±»å‹ä¸º int64
   - å¤§å°/å¯¹é½å€¼ä¸º 8 å­—èŠ‚
   - æ ¹æ®è§„åˆ™1ï¼Œå…¶åç§»é‡å¿…é¡»ä¸º 8 çš„æ•´æ•°å€ã€‚å½“å‰åç§»é‡ä¸º 8ã€‚ä¸éœ€è¦é¢å¤–å¯¹é½ï¼Œä» 9-16 ä½å¡«å…… 8 ä¸ªå­—èŠ‚ã€‚å¦‚ä¸‹ï¼šecax\|bbbb\|dddd\|dddd

### æ•´ä½“å¯¹é½

ç¬¦åˆè§„åˆ™ 2ï¼Œä¸éœ€è¦é¢å¤–å¯¹é½

### ç»“æœ

Part2 å†…å­˜å¸ƒå±€ï¼šecax\|bbbb\|dddd\|dddd

# æ€»ç»“

é€šè¿‡å¯¹æ¯” `Part1` å’Œ `Part2` çš„å†…å­˜å¸ƒå±€ï¼Œä½ ä¼šå‘ç°ä¸¤è€…æœ‰å¾ˆå¤§çš„ä¸åŒã€‚å¦‚ä¸‹ï¼š

- Part1ï¼šaxxx\|bbbb\|cxxx\|xxxx\|dddd\|dddd\|exxx\|xxxx

- Part2ï¼šecax\|bbbb\|dddd\|dddd

ä»”ç»†ä¸€çœ‹ï¼Œ`Part1` å­˜åœ¨è®¸å¤š Paddingã€‚æ˜¾ç„¶å®ƒå æ®äº†ä¸å°‘ç©ºé—´ï¼Œé‚£ä¹ˆ Padding æ˜¯æ€ä¹ˆå‡ºç°çš„å‘¢ï¼Ÿ

é€šè¿‡æœ¬æ–‡çš„ä»‹ç»ï¼Œå¯å¾—çŸ¥æ˜¯ç”±äºä¸åŒç±»å‹å¯¼è‡´éœ€è¦è¿›è¡Œå­—èŠ‚å¯¹é½ï¼Œä»¥æ­¤ä¿è¯å†…å­˜çš„è®¿é—®è¾¹ç•Œ

é‚£ä¹ˆä¹Ÿä¸éš¾ç†è§£ï¼Œä¸ºä»€ä¹ˆ**è°ƒæ•´ç»“æ„ä½“å†…æˆå‘˜å˜é‡çš„å­—æ®µé¡ºåº**å°±èƒ½è¾¾åˆ°ç¼©å°ç»“æ„ä½“å ç”¨å¤§å°çš„ç–‘é—®äº†ï¼Œæ˜¯å› ä¸ºå·§å¦™åœ°å‡å°‘äº† Padding çš„å­˜åœ¨ã€‚è®©å®ƒä»¬æ›´ â€œç´§å‡‘â€ äº†ã€‚è¿™ä¸€ç‚¹å¯¹äºåŠ æ·± Go çš„å†…å­˜å¸ƒå±€å°è±¡å’Œå¤§å¯¹è±¡çš„ä¼˜åŒ–éå¸¸æœ‰å¸®

å½“ç„¶äº†ï¼Œæ²¡ä»€ä¹ˆç‰¹æ®Šé—®é¢˜ï¼Œä½ å¯ä»¥ä¸å…³æ³¨è¿™ä¸€å—ã€‚ä½†ä½ è¦çŸ¥é“è¿™å—çŸ¥è¯†ç‚¹ ğŸ˜„

# å‚è€ƒæ–‡çŒ®

- [(åŸæ–‡) åœ¨Goä¸­æ°åˆ°å¥½å¤„çš„å†…å­˜å¯¹é½](https://github.com/EDDYCJY/blog/blob/master/golang/2018-12-26-%E5%9C%A8Go%E4%B8%AD%E6%81%B0%E5%88%B0%E5%A5%BD%E5%A4%84%E7%9A%84%E5%86%85%E5%AD%98%E5%AF%B9%E9%BD%90.md)
- [Data structure alignment](https://en.wikipedia.org/wiki/Data_structure_alignment)
- [Data alignment](https://www.ibm.com/developerworks/library/pa-dalign/)
